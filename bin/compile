#!/usr/bin/env bash
# bin/compile <BUILD_DIR> <CACHE_DIR> <ENV_DIR>

# Paths constants
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
cd $BUILD_DIR

INSTALLER_URL="ftp://tug.org/historic/systems/texlive/2019/tlnet-final/install-tl-unx.tar.gz"
INSTALLER_ARCHIVE="$CACHE_DIR/installer-tl-unix.tar.gz"
INSTALLER_ARCHIVE_SHASUM="$CACHE_DIR/shasum"
PLATFORM=$(uname -m)-$(uname -s | tr A-Z a-z)
DESTDIR=$BUILD_DIR/TeXLive
PROFILE="$CACHE_DIR/texlive.profile"

# add the XeLaTeX to the future PATH + update actual PATH
echo ":$BUILD_DIR/TeXLive/bin/$PLATFORM" >> $ENV_DIR/PATH
echo ":$BUILD_DIR/TeXLive/bin/$PLATFORM" >> $ENV_DIR/BIN_PATH
export PATH="$PATH:$BUILD_DIR/buildpack/bin/$PLATFORM"


rm -f $PROFILE
cat > $PROFILE <<EOF
# texlive.profile written on Tue Jan  5 08:15:44 2021 UTC
# It will NOT be updated and reflects only the
# installation profile at installation time.
selected_scheme scheme-minimal
TEXDIR $BUILD_DIR/TexLive
TEXMFCONFIG \$TEXMFSYSCONFIG
TEXMFHOME \$TEXMFLOCAL
TEXMFLOCAL $BUILD_DIR/TexLive/texmf-local
TEXMFSYSCONFIG $BUILD_DIR/TexLive/texmf-config
TEXMFSYSVAR $BUILD_DIR/TexLive/texmf-var
TEXMFVAR \$TEXMFSYSVAR
binary_x86_64-linux 1
instopt_adjustpath 1
instopt_adjustrepo 1
instopt_letter 0
instopt_portable 1
instopt_write18_restricted 1
tlpdbopt_autobackup 1
tlpdbopt_backupdir tlpkg/backups
tlpdbopt_create_formats 1
tlpdbopt_desktop_integration 1
tlpdbopt_file_assocs 1
tlpdbopt_generate_updmap 0
tlpdbopt_install_docfiles 1
tlpdbopt_install_srcfiles 1
tlpdbopt_post_code 1
tlpdbopt_sys_bin /usr/local/bin
tlpdbopt_sys_info /usr/local/share/info
tlpdbopt_sys_man /usr/local/share/man
tlpdbopt_w32_multi_user 1
EOF

cat > $INSTALLER_ARCHIVE_SHASUM <<EOF
ae330a14325a6658629b548f9a6a3d38a6877d67  $INSTALLER_ARCHIVE
EOF

# download installer archive, open and run installer
if test -r $INSTALLER_ARCHIVE && shasum --check $INSTALLER_ARCHIVE_SHASUM; then
    echo "Using old install_tl archive."
else
    rm -f $INSTALLER_ARCHIVE
    wget $INSTALLER_URL --output-document=$INSTALLER_ARCHIVE
fi
if false; then
tar xzf $INSTALLER_ARCHIVE
./"install-tl-"*/install-tl --repository=http://tug.org/historic/systems/texlive/2019/tlnet-final --profile=$PROFILE
fi

echo "Update CTAN pckgs list."
$DESTDIR/bin/$PLATFORM/tlmgr update --list

# Add custom packages
echo "Going to install required tex pckgs."
while read -r line; do
    $DESTDIR/bin/$PLATFORM/tlmgr install $line
done < $BUILD_DIR/tl_pkg.txt
# Remove custom packages
if [ -f $BUILD_DIR/tex_uninstall.txt ]; then
    while read -r line; do
        $DESTDIR/bin/$PLATFORM/tlmgr remove --force $line
    done < $BUILD_DIR/tex_uninstall.txt
else
    echo "No package to uninstall (empty tex_uninstall.txt)."
fi

# Keep a copy of our profile
cp $PROFILE $DESTDIR/install.profile

## add to PATH
echo "exporting PATH "
PROFILE_PATH="$BUILD_DIR/.profile.d/texlive-path-parts.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$HOME/TeXLive/bin/x86_64-linux"' >> $PROFILE_PATH

# final message
echo "*********************"
echo "TeXLive environment installation and packaging complete."
echo "Distribution: $DESTDIR"
echo "Don't forget to add $DESTDIR/bin/$PLATFORM/ to your PATH."

exit 0

